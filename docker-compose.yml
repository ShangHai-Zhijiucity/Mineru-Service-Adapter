# ==========================================
# MinerU Service Adapter - 独立 Compose 配置
# ==========================================
# 使用方法：
#   1. 在项目根目录创建或使用现有的 .env 文件
#   2. 进入此目录执行：docker-compose up -d
#   3. 或从项目根目录执行：docker-compose -f services/mineru/docker-compose.yml up -d
#
# 环境变量配置（在项目根目录的 .env 文件中）：
#   MINERU_WORKER_COUNT=2
#   CUDA_VISIBLE_DEVICES=0
#   MINIO_ENDPOINT=http://localhost:9000
#   MINIO_ACCESS_KEY=minioadmin
#   MINIO_SECRET_KEY=minioadmin
#   MINIO_SECURE=false
#   CONTROLLER_PORT=58001
#   TASK_TIMEOUT_SECONDS=300
#   MINERU_INTERNAL_TOKEN=your-token
#   MINERU_DEFAULT_CALLBACK_URL=http://backend:51080/api/v1/mineru/callback
# ==========================================

networks:
  # 选项1：使用外部网络（如果需要在同一网络中与其他服务通信）
  # 取消注释下面的配置，并在主 compose 中确保网络名称一致
  # bio_network:
  #   external: true
  #   name: bio_network
  
  # 选项2：创建独立的网络（默认）
  mineru_network:
    driver: bridge

volumes:
  models_cache:
    driver: local

services:
  mineru:
    build:
      context: .
      dockerfile: Dockerfile
      # 配置构建时的 DNS
      extra_hosts:
        - "host.docker.internal:host-gateway"
      # 传递 DNS 设置给构建过程
      network: host
    container_name: bio_mineru
    restart: unless-stopped
    network_mode: host
    # 使用 runtime 方式配置 GPU（host 模式下兼容性更好）
    runtime: nvidia
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 223.5.5.5
      - 223.6.6.6
    # env_file 是可选的，如果 .env 文件不存在，将使用 environment 中的默认值
    # 如果有 .env 文件，取消下面的注释：
    # env_file:
    #   - ../../.env
    environment:
      MINERU_WORKER_COUNT: ${MINERU_WORKER_COUNT:-2}
      CUDA_VISIBLE_DEVICES: ${CUDA_VISIBLE_DEVICES:-0}
      # ===== 模型源：本地(local) =====
      # 参考官方文档：
      # https://opendatalab.github.io/MinerU/zh/usage/cli_tools/#_3
      MINERU_MODEL_SOURCE: ${MINERU_MODEL_SOURCE:-local}
      # 指向本地模型目录配置文件（config_reader 默认读 ~/mineru.json）
      MINERU_TOOLS_CONFIG_JSON: ${MINERU_TOOLS_CONFIG_JSON:-/root/mineru.json}
      # 强制离线：避免任何 huggingface/modelscope 探测
      HF_HUB_OFFLINE: ${HF_HUB_OFFLINE:-1}
      TRANSFORMERS_OFFLINE: ${TRANSFORMERS_OFFLINE:-1}
      # MinIO 连接（外部 MinIO）
      # 默认值：如果未配置，请确保在 .env 文件中设置 MINIO_ENDPOINT
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://localhost:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_SECURE: ${MINIO_SECURE:-false}
      CONTROLLER_PORT: ${CONTROLLER_PORT:-58001}
      TASK_TIMEOUT_SECONDS: ${TASK_TIMEOUT_SECONDS:-300}
      # 回调相关配置
      MINERU_INTERNAL_TOKEN: ${MINERU_INTERNAL_TOKEN:-}
      MINERU_DEFAULT_CALLBACK_URL: ${MINERU_DEFAULT_CALLBACK_URL:-}
    # 使用 host 网络模式时，不需要 ports 映射（容器直接使用主机端口）
    # ports:
    #   - "${MINERU_CONTROLLER_PORT:-58001}:58001"
    volumes:
      # MinerU 配置文件
      - ./mineru_config.json:/root/magic-pdf.json:ro
      # 模型缓存目录（优先使用主机目录，如果没有则使用 Docker volume）
      # 选项1: 使用主机目录（推荐，便于管理）
      - ./models/magic-pdf/.cache:/root/.cache/magic-pdf
      # MinerU 本地模型路径配置（供 MINERU_MODEL_SOURCE=local 使用）
      - ./mineru_local_models.json:/root/mineru.json:ro
      # 选项2: 使用 Docker volume（取消注释下面这行，注释掉上面这行）
      # - models_cache:/root/.cache/magic-pdf
    # 使用 host 网络模式时，不需要 networks 配置
    # networks:
    #   - mineru_network
    # GPU 配置已通过 runtime: nvidia 设置
    # 如果需要限制 GPU 数量，使用环境变量 CUDA_VISIBLE_DEVICES
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:58001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

